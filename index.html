<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3Dç²’å­æ‰‹åŠ¿æ§åˆ¶ç³»ç»Ÿ</title>
    <style>
        /* --- ç°ä»£åŒ– UI è®¾è®¡è§„èŒƒ --- */
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Roboto', sans-serif; user-select: none; }
        
        /* æ‘„åƒå¤´é¢„è§ˆçª— (å·¦ä¸‹è§’ï¼Œé•œåƒç¿»è½¬) */
        #cam-box {
            position: absolute; bottom: 15px; left: 15px; width: 160px; height: 120px;
            border: 1px solid rgba(0, 255, 0, 0.3); border-radius: 8px;
            transform: scaleX(-1); background: #000; overflow: hidden; z-index: 10;
            box-shadow: 0 0 10px rgba(0,255,0,0.1);
        }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* çŠ¶æ€æç¤º */
        #status-bar {
            position: absolute; bottom: 145px; left: 15px;
            color: #00ff00; font-size: 12px; background: rgba(0,20,0,0.6);
            padding: 4px 8px; border-radius: 4px; border-left: 3px solid #00ff00;
            display: flex; align-items: center; gap: 5px;
        }

        /* ä¸»æ§åˆ¶é¢æ¿ (å³ä¾§æ‚¬æµ®) */
        #controls {
            position: absolute; top: 50%; right: 20px; transform: translateY(-50%);
            width: 180px;
            background: rgba(20, 30, 20, 0.85); backdrop-filter: blur(10px);
            padding: 20px; border-radius: 16px; border: 1px solid rgba(0, 255, 0, 0.15);
            color: #fff; z-index: 20;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        h3 { margin: 0 0 15px 0; font-size: 14px; color: #00ff00; letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid rgba(0,255,0,0.2); padding-bottom: 8px;}

        /* æŒ‰é’®ç½‘æ ¼ */
        .btn-grid { display: flex; flex-direction: column; gap: 8px; }
        
        .btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            color: #ddd; padding: 10px; border-radius: 8px; 
            cursor: pointer; font-size: 13px; transition: all 0.3s; text-align: left;
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn:hover { background: rgba(0, 255, 0, 0.1); border-color: #00ff00; }
        .btn.active { background: #00ff00; color: #000; font-weight: bold; box-shadow: 0 0 15px rgba(0,255,0,0.4); }
        .btn.active::after { content: 'â—'; font-size: 10px; }

        /* åŠ è½½é¡µ */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: #00ff00;
        }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top: 3px solid #00ff00; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* å¼ºåˆ¶æ¨ªå±æç¤º (ä»…åœ¨ç«–å±æ˜¾ç¤º) */
        @media (orientation: portrait) {
            #landscape-tip { display: flex; }
        }
        #landscape-tip {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; color: #fff;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
    </style>
</head>
<body>

    <!-- ç«–å±é®ç½© -->
    <div id="landscape-tip">
        <div style="font-size: 40px; margin-bottom: 20px;">âŸ³</div>
        <div>ä¸ºäº†æœ€ä½³ä½“éªŒ<br>è¯·æ—‹è½¬æ‰‹æœºè‡³æ¨ªå±</div>
    </div>

    <!-- åŠ è½½å±‚ -->
    <div id="loader">
        <div class="spinner"></div>
        <div id="load-text">æ­£åœ¨åˆå§‹åŒ–å…¨æ¯å¼•æ“...</div>
    </div>

    <!-- çŠ¶æ€æ¡ -->
    <div id="status-bar">
        <span id="indicator" style="color:red">â—</span> 
        <span id="status-text">æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...</span>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div id="controls">
        <h3>æ¨¡å‹é€‰æ‹©</h3>
        <div class="btn-grid">
            <button class="btn" onclick="setShape('tree', this)">ğŸ„ åœ£è¯æ ‘</button>
            <button class="btn" onclick="setShape('star', this)">â­ ç’€ç’¨æ˜Ÿäº‘</button>
            <button class="btn" onclick="setShape('firework', this)">ğŸ† ç››å¤§çƒŸèŠ±</button>
            <button class="btn" onclick="setShape('heart', this)">â¤ï¸ æœºæ¢°ä¹‹å¿ƒ</button>
            <button class="btn" onclick="setShape('earth', this)">ğŸŒ çŸ©é˜µåœ°çƒ</button>
            <button class="btn active" onclick="setShape('magic', this)">ğŸ”® å¬å”¤æ³•é˜µ</button>
        </div>
        <div style="margin-top: 20px; font-size: 11px; color: #666; border-top: 1px solid #333; padding-top: 10px;">
            äº¤äº’ï¼šæåˆæ‰‹æŒ‡ç¼©æ”¾ / æ‹–æ‹½æ—‹è½¬
        </div>
    </div>

    <div id="cam-box"><video id="video" autoplay playsinline muted></video></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        // --- ç³»ç»Ÿå˜é‡ ---
        let scene, camera, renderer, particles, geometry, material;
        const PARTICLE_COUNT = 12000; // ç²’å­æ•°é‡
        let targetPositions = [];
        let handScale = 1.0, targetHandScale = 1.0; 
        let isDragging = false, mouseX=0, mouseY=0, rotX=0, rotY=0;
        
        // --- æ ¸å¿ƒç®—æ³•åº“ ---
        const shapes = {
            // 1. åœ£è¯æ ‘ (åœ†é”¥ä½“èºæ—‹)
            tree: () => {
                const arr = [];
                for(let i=0; i<PARTICLE_COUNT; i++) {
                    const h = (i / PARTICLE_COUNT) * 10 - 5; // é«˜åº¦ä»-5åˆ°5
                    const angle = i * 0.1; 
                    const r = (5 - h) * 0.5 + Math.random() * 0.5; // åŠå¾„éšé«˜åº¦å‡å°
                    // æ·»åŠ ä¸€äº›éšæœºæ•£å¸ƒä½œä¸ºè£…é¥°
                    if(Math.random() > 0.9) {
                         arr.push((r+0.5)*Math.cos(angle), h, (r+0.5)*Math.sin(angle));
                    } else {
                         arr.push(r*Math.cos(angle), h, r*Math.sin(angle));
                    }
                }
                return arr;
            },
            // 2. æ˜Ÿæ˜Ÿ (äº”è§’æ˜Ÿä½“)
            star: () => {
                const arr = [];
                for(let i=0; i<PARTICLE_COUNT; i++) {
                    const u = Math.random()*Math.PI*2, v = Math.random()*Math.PI - Math.PI/2;
                    const r = 3 + Math.pow(Math.sin(u*5)*Math.cos(v*5), 2)*3; 
                    arr.push(r*Math.cos(u)*Math.cos(v), r*Math.sin(u)*Math.cos(v), r*Math.sin(v)); 
                }
                return arr;
            },
            // 3. çƒŸèŠ± (çˆ†ç‚¸çƒä½“ + æ‹–å°¾)
            firework: () => {
                const arr = [];
                for(let i=0; i<PARTICLE_COUNT; i++) {
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos((Math.random() * 2) - 1);
                    const r = Math.pow(Math.random(), 0.3) * 6; // åå‘å¤–ä¾§åˆ†å¸ƒ
                    arr.push(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
                }
                return arr;
            },
            // 4. çˆ±å¿ƒ
            heart: () => {
                const arr = [];
                for(let i=0; i<PARTICLE_COUNT; i++) {
                    let x, y, z;
                    while(true) { x = (Math.random()*4-2)*1.5; y = (Math.random()*4-2)*1.5; z = (Math.random()*4-2)*1.5; if (Math.pow(x*x + 2.25*y*y + z*z - 1, 3) - x*x*z*z*z - 0.1125*y*y*z*z*z <= 0) break; }
                    arr.push(x*3, (y+0.3)*3, z*3);
                }
                return arr;
            },
            // 5. åœ°çƒ
            earth: () => {
                const arr = [];
                for(let i=0; i<PARTICLE_COUNT; i++) {
                    const phi = Math.acos(-1 + (2 * i) / PARTICLE_COUNT);
                    const theta = Math.sqrt(PARTICLE_COUNT * Math.PI) * phi;
                    const r = 5.0;
                    arr.push(r * Math.cos(theta) * Math.sin(phi), r * Math.sin(theta) * Math.sin(phi), r * Math.cos(phi));
                }
                return arr;
            },
            // 6. é­”æ³•é˜µ (æ‰å¹³åŒå¿ƒåœ†ç»“æ„)
            magic: () => {
                const arr = [];
                for(let i=0; i<PARTICLE_COUNT; i++) {
                    const r = Math.random();
                    let x, y, z=0;
                    if (r < 0.3) { // å¤–åœˆ
                        const t = Math.random() * Math.PI * 2;
                        x = 6 * Math.cos(t); y = 6 * Math.sin(t);
                    } else if (r < 0.6) { // å…­èŠ’æ˜Ÿè¿çº¿
                        const t = Math.random() * Math.PI * 2;
                        x = (3 + Math.sin(t*3)) * Math.cos(t); y = (3 + Math.sin(t*3)) * Math.sin(t);
                    } else { // å†…éƒ¨ç¬¦æ–‡
                        x = (Math.random()-0.5)*4; y = (Math.random()-0.5)*4;
                    }
                    arr.push(x, y, z);
                }
                return arr;
            }
        };

        window.onload = function() {
            initThree();
            initAI();
            animate();
            // é»˜è®¤é€‰ä¸­é­”æ³•é˜µ
            setShape('magic', document.querySelectorAll('.btn')[5]); 
        };

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
            camera.position.z = 18;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // æ€§èƒ½ä¼˜åŒ–
            document.body.appendChild(renderer.domElement);

            // ç²’å­çº¹ç†
            const c = document.createElement('canvas'); c.width=32; c.height=32;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle=g; ctx.fillRect(0,0,32,32);

            // æè´¨ï¼šå¼ºåˆ¶ç»¿è‰² #00ff00
            material = new THREE.PointsMaterial({ 
                size: 0.2, 
                color: 0x00ff00, 
                map: new THREE.CanvasTexture(c), 
                transparent: true, 
                opacity: 0.8, 
                blending: THREE.AdditiveBlending, 
                depthWrite: false 
            });
            
            geometry = new THREE.BufferGeometry();
            const curr = new Float32Array(PARTICLE_COUNT*3);
            for(let i=0;i<curr.length;i++) curr[i]=(Math.random()-0.5)*50; // åˆå§‹çˆ†ç‚¸çŠ¶æ€
            geometry.setAttribute('position', new THREE.BufferAttribute(curr, 3));
            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            // äº¤äº’äº‹ä»¶
            const d = renderer.domElement;
            d.addEventListener('touchstart', e=>{
                isDragging=true; 
                mouseX=e.touches[0].clientX; 
                mouseY=e.touches[0].clientY;
            }, {passive: false});
            d.addEventListener('touchend', ()=>isDragging=false);
            d.addEventListener('touchmove', e=>{ 
                if(isDragging) { 
                    e.preventDefault();
                    rotY += (e.touches[0].clientX-mouseX)*0.005; 
                    rotX += (e.touches[0].clientY-mouseY)*0.005; 
                    particles.rotation.y = rotY; 
                    particles.rotation.x = rotX; 
                    mouseX=e.touches[0].clientX; 
                    mouseY=e.touches[0].clientY; 
                } 
            }, {passive: false});

            window.addEventListener('resize', ()=>{ 
                camera.aspect=window.innerWidth/window.innerHeight; 
                camera.updateProjectionMatrix(); 
                renderer.setSize(window.innerWidth,window.innerHeight); 
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            
            // è‡ªåŠ¨ç¼“æ…¢æ—‹è½¬
            if(!isDragging) { particles.rotation.y += 0.002; rotY=particles.rotation.y; }

            // æ‰‹åŠ¿ç¼©æ”¾å¹³æ»‘è¿‡æ¸¡
            handScale += (targetHandScale - handScale) * 0.1;
            particles.scale.set(handScale, handScale, handScale);

            // ç²’å­ä½ç½®æ’å€¼ (MorphingåŠ¨ç”»)
            const pos = geometry.attributes.position.array;
            if(targetPositions.length > 0) {
                for(let i=0; i<PARTICLE_COUNT*3; i++) {
                    pos[i] += (targetPositions[i] - pos[i]) * 0.08;
                }
            }
            geometry.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }

        function initAI() {
            const videoElement = document.getElementById('video');
            const statusText = document.getElementById('status-text');
            const indicator = document.getElementById('indicator');
            const loader = document.getElementById('loader');

            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});

            hands.setOptions({
                maxNumHands: 1, 
                modelComplexity: 0, // æ€§èƒ½ä¼˜å…ˆæ¨¡å¼
                minDetectionConfidence: 0.5, 
                minTrackingConfidence: 0.5
            });

            hands.onResults(results => {
                loader.style.display = 'none'; // é¦–æ¬¡è¯†åˆ«åå…³é—­Loading
                
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const lm = results.multiHandLandmarks[0];
                    // è®¡ç®—æ‹‡æŒ‡æŒ‡å°–(4)å’Œé£ŸæŒ‡æŒ‡å°–(8)çš„è·ç¦»
                    const d = Math.sqrt(Math.pow(lm[4].x - lm[8].x, 2) + Math.pow(lm[4].y - lm[8].y, 2));
                    
                    // æ˜ å°„è·ç¦»åˆ°ç¼©æ”¾æ¯”ä¾‹ (0.5 ~ 2.5)
                    targetHandScale = 0.5 + (d * 8.0); 
                    
                    indicator.style.color = '#00ff00';
                    statusText.innerText = `å·²è¿æ¥æ‰‹åŠ¿ (å¼ºåº¦: ${(d*100).toFixed(0)}%)`;
                } else {
                    indicator.style.color = 'red';
                    statusText.innerText = "ç­‰å¾…æ‰‹åŠ¿æŒ‡ä»¤...";
                }
            });

            const camera = new Camera(videoElement, {
                onFrame: async () => await hands.send({image: videoElement}),
                width: 320, height: 240 // ä½åˆ†è¾¨ç‡è¾“å…¥æå‡æ€§èƒ½
            });

            camera.start()
                .then(() => console.log("Camera started"))
                .catch(e => {
                    statusText.innerText = "æ‘„åƒå¤´æƒé™è¢«æ‹’ç»æˆ–ä¸å¯ç”¨";
                    loader.style.display = 'none';
                    alert("è¯·å…è®¸æ‘„åƒå¤´æƒé™ä»¥ä½“éªŒæ‰‹åŠ¿æ§åˆ¶");
                });
        }

        window.setShape = function(n, b) { 
            targetPositions = shapes[n](); 
            document.querySelectorAll('.btn').forEach(x=>x.classList.remove('active')); 
            b.classList.add('active'); 
        }
    </script>
</body>
</html>